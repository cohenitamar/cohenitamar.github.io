<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Exercise Tracker</title>
  <style>
    :root{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{margin:0;padding:18px;background:#f6f7fb;color:#111}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,.06);padding:18px;max-width:900px;margin:16px auto}
    header{display:flex;align-items:center;justify-content:space-between}
    form{display:flex;gap:8px;flex-wrap:wrap}
    input,button,select{padding:8px 10px;border-radius:8px;border:1px solid #e6e8f0}
    button{cursor:pointer}
    .muted{color:#666;font-size:13px}
    .list{margin-top:14px}
    .item{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;border:1px solid #f0f2f8;margin-bottom:8px}
    .controls button{margin-left:6px}
    .auth{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .small{font-size:13px;padding:6px 8px}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h2 style="margin:0">Exercise Tracker</h2>
        <div class="muted">Tracks exercises/weights with Supabase (Postgres + Auth). No Firebase.</div>
      </div>
      <div class="auth">
        <div id="user-info" class="muted">Not signed in</div>
        <button id="btn-signout" class="small hidden">Sign out</button>
      </div>
    </header>

    <section id="auth-area" class="card" style="margin-top:12px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="email" placeholder="Email" type="email">
        <input id="password" placeholder="Password (min 6 chars)" type="password">
        <button id="btn-signup" class="small">Sign up</button>
        <button id="btn-signin" class="small">Sign in</button>
        <div style="margin-left:8px" class="muted">Only authenticated users can access their own data.</div>
      </div>
    </section>

    <section id="app-area" class="hidden">
      <form id="add-form" style="margin-top:12px">
        <input id="exercise" placeholder="Exercise (e.g. Bench Press)" required>
        <input id="weight" placeholder="Weight (kg)" type="number" step="0.1" required>
        <input id="date" type="date" required>
        <button type="submit">Add / Save</button>
        <button type="button" id="cancel-edit" class="small hidden">Cancel</button>
      </form>

      <div class="list" id="list"></div>
    </section>

    <div class="muted" style="margin-top:12px;font-size:13px">Setup notes are at the bottom of this file.</div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***** IMPORTANT: Replace with your Supabase project values *****/
    const SUPABASE_URL = 'https://cozyhjiqghqzqalvjwxn.supabase.co'; // <- replace
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvenloamlxZ2hxenFhbHZqd3huIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNzI5MDcsImV4cCI6MjA3Mzg0ODkwN30.pT3BWtrWWp5wag18qvegWqKXrY5J2hpEuehGXgaQQ_s'; // <- replace

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI elements
    const authArea = document.getElementById('auth-area');
    const appArea = document.getElementById('app-area');
    const userInfo = document.getElementById('user-info');
    const btnSignout = document.getElementById('btn-signout');
    const btnSignup = document.getElementById('btn-signup');
    const btnSignin = document.getElementById('btn-signin');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const addForm = document.getElementById('add-form');
    const listEl = document.getElementById('list');
    const exerciseEl = document.getElementById('exercise');
    const weightEl = document.getElementById('weight');
    const dateEl = document.getElementById('date');
    const cancelEdit = document.getElementById('cancel-edit');

    let editId = null;
    let currentUser = null;

    // ---------- Auth ----------
    async function refreshSession(){
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      if(user){
        userInfo.textContent = user.email;
        btnSignout.classList.remove('hidden');
        authArea.classList.add('hidden');
        appArea.classList.remove('hidden');
        await loadList();
        subscribeRealtime();
      } else {
        userInfo.textContent = 'Not signed in';
        btnSignout.classList.add('hidden');
        authArea.classList.remove('hidden');
        appArea.classList.add('hidden');
        listEl.innerHTML = '';
      }
    }

    btnSignup.addEventListener('click', async ()=>{
      const { error } = await supabase.auth.signUp({ email: emailEl.value, password: passEl.value });
      if(error) return alert(error.message);
      alert('Check your inbox to confirm your email (if required).');
    });

    btnSignin.addEventListener('click', async ()=>{
      const { error } = await supabase.auth.signInWithPassword({ email: emailEl.value, password: passEl.value });
      if(error) return alert(error.message);
    });

    btnSignout.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
    });

    supabase.auth.onAuthStateChange((_event, _session)=>{
      refreshSession();
    });

    // ---------- Data ----------
    async function loadList(){
      if(!currentUser) return;
      const { data, error } = await supabase
        .from('exercises')
        .select('*')
        .order('date', { ascending: false });
      if(error){ alert(error.message); return; }
      renderList(data || []);
    }

    addForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser) return alert('Sign in first');
      const row = {
        exercise: exerciseEl.value.trim(),
        weight: parseFloat(weightEl.value),
        date: dateEl.value
      };
      let error;
      if(editId){
        ({ error } = await supabase.from('exercises').update(row).eq('id', editId));
        editId = null; cancelEdit.classList.add('hidden');
      } else {
        ({ error } = await supabase.from('exercises').insert(row));
      }
      if(error){ alert(error.message); return; }
      addForm.reset();
    });

    cancelEdit.addEventListener('click', ()=>{ editId=null; cancelEdit.classList.add('hidden'); addForm.reset(); });

    function renderList(items){
      listEl.innerHTML = '';
      if(items.length===0){ listEl.innerHTML = '<div class="muted">No exercises yet.</div>'; return }
      for(const it of items){
        const div = document.createElement('div'); div.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${escapeHtml(it.exercise)}</strong><div class="muted">${it.date} â€¢ ${it.weight} kg</div>`;
        const controls = document.createElement('div'); controls.className='controls';
        const btnEdit = document.createElement('button'); btnEdit.textContent='Edit'; btnEdit.className='small';
        const btnDel = document.createElement('button'); btnDel.textContent='Delete'; btnDel.className='small';
        btnEdit.addEventListener('click', ()=>startEdit(it));
        btnDel.addEventListener('click', async ()=>{
          if(!confirm('Delete this entry?')) return;
          const { error } = await supabase.from('exercises').delete().eq('id', it.id);
          if(error) alert(error.message);
        });
        controls.appendChild(btnEdit); controls.appendChild(btnDel);
        div.appendChild(left); div.appendChild(controls);
        listEl.appendChild(div);
      }
    }

    function startEdit(it){
      editId = it.id; exerciseEl.value = it.exercise; weightEl.value = it.weight; dateEl.value = it.date;
      cancelEdit.classList.remove('hidden');
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

    // ---------- Realtime ----------
    let channel;
    function subscribeRealtime(){
      if(channel) supabase.removeChannel(channel);
      channel = supabase.channel('public:exercises')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'exercises' }, (payload)=>{
          loadList();
        })
        .subscribe();
    }

    refreshSession();
  </script>

  <!-- SETUP (keep in the file for reference) =======================================

  1) Create a Supabase project: https://supabase.com/
  2) Get your Project URL and anon key: Project Settings -> API. Put them in SUPABASE_URL/KEY above.
  3) Create table and policies (SQL below). Go to SQL editor in Supabase and run:

  -- Table
  create table if not exists public.exercises (
    id uuid primary key default gen_random_uuid(),
    user_id uuid not null references auth.users(id) on delete cascade,
    exercise text not null,
    weight numeric not null,
    date date not null,
    inserted_at timestamp with time zone default now()
  );

  -- Enable Row Level Security
  alter table public.exercises enable row level security;

  -- Policies: each user can manage only their rows
  create policy "Users can read own rows" on public.exercises
    for select using (auth.uid() = user_id);
  create policy "Users can insert own rows" on public.exercises
    for insert with check (auth.uid() = user_id);
  create policy "Users can update own rows" on public.exercises
    for update using (auth.uid() = user_id);
  create policy "Users can delete own rows" on public.exercises
    for delete using (auth.uid() = user_id);

  -- Trigger to auto-fill user_id on insert from JWT
  create or replace function public.handle_exercises_user_id()
  returns trigger as $$
  begin
    new.user_id := auth.uid();
    return new;
  end;
  $$ language plpgsql security definer;

  drop trigger if exists set_exercises_user_id on public.exercises;
  create trigger set_exercises_user_id
  before insert on public.exercises
  for each row execute procedure public.handle_exercises_user_id();

  4) Auth settings: enable Email/Password signups (or restrict to an allowlist under Auth -> Policies).
     If you want to block random signups, set up an **email allowlist** via Auth -> Policies -> Add policy -> 
     "Only allow these email domains/addresses" or use Admin invite-only.

  5) Deploy to GitHub Pages:
     - Put this file as `index.html` in `<your-username>.github.io` repo.
     - Commit & push. The frontend talks directly to Supabase's REST/WebSocket endpoints.

  OPTIONAL hardening:
    - Turn off new registrations and create your own user manually in the dashboard.
    - Add an allowlist: create a Postgres function that checks `auth.jwt()` for allowed emails; add to all policies.
    - Use OTP (magic link) instead of passwords.

  -->
</body>
</html>
